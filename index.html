<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>معلومات الموظف</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { margin:0; font-family:'Cairo',sans-serif; background-color:#f9f9fb; }
    .container { display:flex; min-height:100vh; }
    aside { width:260px; background-color:#0f1f3e; color:#fff; padding:22px; }
    aside h2 { text-align:center; font-size:18px; margin-bottom:30px; }
    aside ul { list-style:none; padding:0; }
    aside ul li { margin-bottom:15px; background:#1c2f53; padding:10px; border-radius:6px; cursor:pointer; }
    aside ul li:hover { background:#29508f; }
    aside ul li span { margin-right:8px; }
    main { flex-grow:1; background:#fff; padding:28px; }
    .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:20px; margin-bottom:10px; }
    .form-grid label { font-weight:600; margin-bottom:5px; display:block; }
    .form-grid input { width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; }
    .section-title { font-weight:bold; font-size:16px; margin:18px 0 12px 0; }
    .upload-section { display:flex; flex-wrap:wrap; gap:20px; margin-top:10px; }
    .upload-box { flex:1 1 220px; background:#f5f6fa; border:1px dashed #ccc; border-radius:8px; padding:15px; text-align:center; }
    .upload-box input[type="file"] { display:block; margin:10px auto 0 auto; }
    .button-row { margin-top:18px; display:flex; gap:10px; flex-wrap:wrap; }
    button { padding:10px 20px; background:#337ab7; color:#fff; border:0; border-radius:6px; cursor:pointer; }
    button:hover { background:#23527c; }
    .note { font-size:13px; color:#666; margin-top:8px; }
    .link { margin-top:6px; font-size:14px; }
    .link a{ color:#0b74da; text-decoration:none; }
    .status{ margin-top:10px; font-size:14px;}
    .err{ color:#a02222; display:none; }
    .ok{ color:#1a7f37; display:none; }
  </style>
</head>
<body>

<div class="container">
  <aside>
    <h2 id="sidebarName">—</h2>
    <ul>
      <li><span>🕓</span> تسجيل الحضور والانصراف</li>
      <li><span>👤</span> معلومات الموظف</li>
      <li><span>📄</span> عرض الكشوفات الشهرية</li>
      <li><span>📝</span> رفع طلب إجازة</li>
      <li><span>📃</span> رفع طلب تعريف راتب</li>
      <li><span>🛡️</span> رفع طلب تأمين</li>
    </ul>
  </aside>

  <main>
    <h2>معلومات الموظف</h2>

    <div class="form-grid">
      <div>
        <label>الاسم</label>
        <input type="text" id="name" readonly>
      </div>
      <div>
        <label>رقم الهوية</label>
        <input type="text" id="nid" readonly>
      </div>
      <div>
        <label>رقم الهاتف</label>
        <input type="text" id="phone" readonly>
      </div>
      <div>
        <label>الإيميل</label>
        <input type="email" id="email" readonly>
      </div>
      <div style="grid-column: 1 / -1;">
        <label>جهة التكليف</label>
        <input type="text" id="assignment" readonly>
      </div>
    </div>

    <div class="section-title">ملفاتي (PDF)</div>
    <div class="upload-section">
      <div class="upload-box">
        <div>📎 السيرة الذاتية (CV)</div>
        <input type="file" id="cv" accept="application/pdf">
        <div class="link" id="cvLink"></div>
      </div>
      <div class="upload-box">
        <div>📎 الهوية الوطنية</div>
        <input type="file" id="nationalID" accept="application/pdf">
        <div class="link" id="nationalIDLink"></div>
      </div>
      <div class="upload-box">
        <div>📎 شهادة الإيبان</div>
        <input type="file" id="iban" accept="application/pdf">
        <div class="link" id="ibanLink"></div>
      </div>
      <div class="upload-box">
        <div>📎 العنوان الوطني</div>
        <input type="file" id="address" accept="application/pdf">
        <div class="link" id="addressLink"></div>
      </div>
    </div>

    <div class="button-row">
      <button id="btnLoad">تحديث البيانات من الشيت</button>
      <button id="btnUpload">حفظ/رفع الملفات</button>
      <button id="btnLogout">تسجيل الخروج</button>
    </div>
    <div class="status">
      <span id="ok" class="ok">تم بنجاح.</span>
      <span id="err" class="err">حدث خطأ.</span>
    </div>
  </main>
</div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyoV5Zd8RAUG2ZHxl8ILmcsmYoarSNMR_sJRNpWzeB30eQBb1kGNK4dfjtZpq3x5nLsXQ/exec'; 
const ok = document.getElementById('ok');
const err = document.getElementById('err');
function showOk(msg){ ok.textContent = msg || 'تم بنجاح.'; ok.style.display='inline'; err.style.display='none'; }
function showErr(msg){ err.textContent = msg || 'حدث خطأ.'; err.style.display='inline'; ok.style.display='none'; }

const empEmail = localStorage.getItem('emp_email');
const empId = localStorage.getItem('emp_id');
const empName = localStorage.getItem('emp_name');
const empAssignment = localStorage.getItem('emp_assignment');
const loginId = localStorage.getItem('emp_loginId');
const password = localStorage.getItem('emp_password');

if(!loginId || !password){
  window.location.href = 'login.html';
}

document.getElementById('sidebarName').textContent = empName || '—';

async function loadProfile(){
  try{
    const res = await fetch(WEB_APP_URL+'?action=getProfile&loginId='+encodeURIComponent(loginId)+'&password='+encodeURIComponent(password));
    const data = await res.json();
    if(!data.success){ showErr(data.message || 'تعذر تحميل البيانات'); return; }
    document.getElementById('name').value = data.name || '';
    document.getElementById('nid').value = data.nationalId || '';
    document.getElementById('phone').value = data.phone || '';
    document.getElementById('email').value = data.email || '';
    document.getElementById('assignment').value = data.assignment || '';

    setLink('cvLink', data.cvUrl);
    setLink('nationalIDLink', data.nationalIdPdfUrl);
    setLink('ibanLink', data.ibanPdfUrl);
    setLink('addressLink', data.addressPdfUrl);
    showOk('تم تحميل البيانات.');
  }catch(e){ showErr('تعذر الاتصال بالخادم'); }
}
function setLink(elemId, url){
  const el = document.getElementById(elemId);
  el.innerHTML = url ? ('<a target="_blank" href="'+url+'">عرض الملف</a>') : '<span class="note">لا يوجد ملف محفوظ</span>';
}

document.getElementById('btnLoad').addEventListener('click', loadProfile);
document.getElementById('btnLogout').addEventListener('click', ()=>{ localStorage.clear(); window.location.href='login.html'; });

document.getElementById('btnUpload').addEventListener('click', async ()=>{
  try{
    const fd = new FormData();
    fd.append('action','saveFiles');
    fd.append('loginId', loginId);
    fd.append('password', password);

    const cv = document.getElementById('cv').files[0];
    const nat = document.getElementById('nationalID').files[0];
    const iban = document.getElementById('iban').files[0];
    const addr = document.getElementById('address').files[0];
    if(cv) fd.append('cv', cv, 'cv.pdf');
    if(nat) fd.append('nationalID', nat, 'national_id.pdf');
    if(iban) fd.append('iban', iban, 'iban.pdf');
    if(addr) fd.append('address', addr, 'address.pdf');

    const res = await fetch(WEB_APP_URL, { method:'POST', body: fd });
    const data = await res.json();
    if(!data.success){ showErr(data.message || 'لم يتم الحفظ'); return; }

    setLink('cvLink', data.cvUrl);
    setLink('nationalIDLink', data.nationalIdPdfUrl);
    setLink('ibanLink', data.ibanPdfUrl);
    setLink('addressLink', data.addressPdfUrl);
    showOk('تم رفع الملفات وتحديث الروابط.');
  }catch(e){ showErr('تعذر الاتصال بالخادم'); }
});

loadProfile();
</script>
</body>
</html>
